<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"wangkexiong.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"always",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ",hits_stats:" results found in  ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:5,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="AEROSPIKE is a really fast NoSQL database. And we will adapt it and do DB change in our product. Here are some learning notes."><meta property="og:type" content="article"><meta property="og:title" content="AEROSPIKE notes"><meta property="og:url" content="https://wangkexiong.github.io/2015-aerospike-notes/"><meta property="og:site_name" content="Thinking &amp; Writing"><meta property="og:description" content="AEROSPIKE is a really fast NoSQL database. And we will adapt it and do DB change in our product. Here are some learning notes."><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2015-06-30T08:58:00.000Z"><meta property="article:modified_time" content="2023-07-17T11:38:57.173Z"><meta property="article:author" content="wangkexiong"><meta property="article:tag" content="blog"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://wangkexiong.github.io/2015-aerospike-notes/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"en"}</script><title>AEROSPIKE notes | Thinking & Writing</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Thinking & Writing" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Thinking & Writing</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">12</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">4</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">10</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a target="_blank" rel="noopener" href="//github.com/wangkexiong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="https://wangkexiong.github.io/2015-aerospike-notes/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//www.gravatar.com/avatar/f26b0e5c590dca182ea3b955f73769e7"><meta itemprop="name" content="wangkexiong"><meta itemprop="description" content="Learning, Memory and Knowledge"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Thinking & Writing"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">AEROSPIKE notes</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2015-06-30 16:58:00" itemprop="dateCreated datePublished" datetime="2015-06-30T16:58:00+08:00">2015-06-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-07-17 19:38:57" itemprop="dateModified" datetime="2023-07-17T19:38:57+08:00">2023-07-17</time></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">Symbols count in article:</span> <span>3.9k</span></span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span>4 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><p>AEROSPIKE is a really fast NoSQL database.</p><p>And we will adapt it and do DB change in our product. Here are some learning notes.</p><span id="more"></span><h2 id="using-20-byte-digest-stored-as-primary-key-in-database"><a class="markdownIt-Anchor" href="#using-20-byte-digest-stored-as-primary-key-in-database"></a> Using 20-byte digest stored as primary key in database</h2><p>By default, Aerospike does not store the actual primary key in the database. It stores the 20-byte digest (hash of the key) by default. This will be a huge saving for the large keys.</p><p>The hash function that Aerospike used is RIPEMD-160, that is known to be secure against collision based attacks. Here is <a target="_blank" rel="noopener" href="https://online.tugraz.at/tug_online/voe_main2.getvolltext?pCurrPk=17675">some research on whether RIPEMD-160 is collision free</a>. If you see messages on key collisions which in Aerospike log, please report this. And, you may be able to write a research paper based on the two keys that caused the collision!</p><p>If the user key needs to persist on the server, use one of the following methods:</p><ul><li>Explicitly store and retrieve the user key in an application defined bin.</li><li>Ask the database to explicitly store key and detect collisions (e.g., in Java, set WritePolicy.sendKey to true).</li></ul><h2 id="record-deletion"><a class="markdownIt-Anchor" href="#record-deletion"></a> Record Deletion</h2><p>Aerospike separates the data into two parts: index and value. The index is always stored in DRAM, the value can be stored in either SSD/HDD or DRAM (with or without disk for persistence). Delete operations only do an in-memory index deletion for the records. The records on the disk are asynchronously removed by a separate defragmentation process. With defragmentation, the database reclaims storage that is no longer needed. In Aerospike there is no need to explicitly mark records for deletion, thereby reducing writes. This deletion approach is extremely effective in case of flash devices, which may have limited write cycles.</p><p>However, with the above performance gains that Aerospike achieves with in-memory index deletion, there is a small chance that the deleted data may not actually be deleted. Consider a scenario where a delete is issued. Before the asynchronous process deletes the record from the disk, the node itself is rebooted. If there is a cold start reboot, the deleted data will be re-indexed and appeared again.</p><p>There are some best practices to avoid this scenario. Starting with release Enterprise Edition 2.1.2, with a Fast Restart, Aerospike does not rebuild the whole index from disk on reboot. This will make sure that the deleted data will not get restored to the index. Additionally, instead of a delete, we recommend that you set a TTL for all the records that go into the database. Records whose TTL have expired will never be re-indexed after a reboot. Setting a low TTL value will ensure the expected deletion behavior.</p><p>Fast Restart (aka Warm Restart), makes use of Linux system shared memory to enable nodes to start up and re-join their cluster much faster. Database index on a server node, along with various other critical data, is allocated in system shared memory which persists even when the server process is stopped. On restarting, the process re-attaches to the persisted memory containing the index and other data, quickly rebuilds some internal state and re-joins its cluster. It does not need to read all the record data from storage drives to rebuild the index. In this way, a node with over 1 billion records will restart in about 10 seconds (as opposed to 40+ minutes without this feature). This allows cluster upgrades and various other operations to go much faster.</p><ul><li>Not using fast-restart feature and <code>cold-start-empty</code> for namespace is set to false (this is the default value). In this case when the node starts, it will read the data from disk and rebuild the index. Because the data has not been removed from disk, the node will think it is still active and build a new index entry for it. So the deleted object will return.</li><li>Those who doesn’t want to pay money for this, please watch on this <a target="_blank" rel="noopener" href="https://github.com/tiancaiamao/aerospike-server">github project</a>. <a target="_blank" rel="noopener" href="http://www.zenlife.tk/">tiancaiamao</a> give his implementation for this.</li><li>‘cold-start-empty’ configuration which prevents data to be loaded from disk, but only by migration from other nodes in the cluster. However, this is a static configure item and cannot be dynamic changed using AMC (Aerospike-management-Console). Which means if you need this configuration in working, you need add the line in configuration file always. But if we include this in the cluster startup, no record will be got from persistent devices.</li><li>A better way is making a monitor process with 2 copy of configuration files, one without ‘cold-start-empty’ configuration and the other one include it. During the very beginning startup, use the one without ‘cold-start-empty’ and we can load data from persistent devices. After that, the monitor process can monitor Aerospike instances. Use the configuration file with ‘cold-start-empty’ when Aerospike instance got down and need to restart.</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a href="/2015-working-with-osgi-container-karaf/" rel="next" title="Working with OSGI container Karaf">Working with OSGI container Karaf<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener("tabs:register",()=>{let{activeClass:t}=CONFIG.comments;if(CONFIG.comments.storage&&(t=localStorage.getItem("comments_active")||t),t){let e=document.querySelector(`a[href="#comment-${t}"]`);e&&e.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{if(!t.target.matches(".tabs-comment .tab-content .tab-pane"))return;let e=t.target.classList[1];localStorage.setItem("comments_active",e)})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#using-20-byte-digest-stored-as-primary-key-in-database"><span class="nav-number">1.</span> <span class="nav-text">Using 20-byte digest stored as primary key in database</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#record-deletion"><span class="nav-number">2.</span> <span class="nav-text">Record Deletion</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="wangkexiong" src="//www.gravatar.com/avatar/f26b0e5c590dca182ea3b955f73769e7"><p class="site-author-name" itemprop="name">wangkexiong</p><div class="site-description" itemprop="description">Learning, Memory and Knowledge</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a target="_blank" rel="noopener" href="//github.com/wangkexiong" title="GitHub → &#x2F;&#x2F;github.com&#x2F;wangkexiong"><i class="fa fa-fw fa-github"></i></a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2013 – <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user-circle-o"></i></span> <span class="author" itemprop="copyrightHolder">wangkexiong</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="Symbols count total">65k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="Reading time total">59 mins.</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script></body></html>